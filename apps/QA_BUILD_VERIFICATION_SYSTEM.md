# Build Verification System

**Prove the running app contains your latest code**

Version: 1.0
Last Updated: 2025-10-30
Purpose: Eliminate build cache issues and verify deployed code at runtime

---

## The Build Cache Problem

### Why Previous Fixes Failed

**Root Cause**: Multiple layers of caching serve stale code:

1. **Metro Bundler Cache**: Serves old JavaScript bundle
2. **Xcode DerivedData**: Compiles old native code
3. **iOS Build Cache**: Reuses previous build artifacts
4. **CocoaPods Cache**: Links old native modules
5. **Node Modules**: Contains outdated dependencies

**Result**: You modify code, rebuild, and run the app, but the OLD code still executes.

**Solution**: Multi-layer verification system that proves new code is deployed.

---

## Verification Strategy

### Three Layers of Proof

1. **Build Artifacts**: Prove compiled bundle contains new code
2. **Runtime Logs**: Prove new code executes when app runs
3. **Version Stamps**: Prove running app matches latest build

---

## Layer 1: Build Artifact Verification

### 1.1 Version Stamping System

**Purpose**: Embed unique identifier in each build to prove which version is running

**Implementation**:

**A. Create build timestamp file**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile

# Create version script
cat > scripts/generate-build-version.sh << 'EOF'
#!/bin/bash
# Generate unique build identifier

BUILD_TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
BUILD_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")

# Create version file
cat > src/version.ts << EOFVER
// Auto-generated by scripts/generate-build-version.sh
// DO NOT EDIT MANUALLY

export const BUILD_VERSION = {
  timestamp: '${BUILD_TIMESTAMP}',
  commit: '${BUILD_COMMIT}',
  branch: '${BUILD_BRANCH}',
};

export const getBuildInfo = () => {
  return \`Build \${BUILD_VERSION.timestamp} (\${BUILD_VERSION.commit})\`;
};
EOFVER

echo "Generated build version: ${BUILD_TIMESTAMP} (${BUILD_COMMIT})"
EOF

chmod +x scripts/generate-build-version.sh
```

**B. Update package.json to run version script**:

```json
{
  "scripts": {
    "prebuild": "bash scripts/generate-build-version.sh",
    "preios": "bash scripts/generate-build-version.sh",
    "preandroid": "bash scripts/generate-build-version.sh"
  }
}
```

**C. Display version in app**:

Create `src/components/BuildInfo.tsx`:

```typescript
import React from 'react';
import { Text, View, StyleSheet } from 'react-native';
import { BUILD_VERSION, getBuildInfo } from '../version';

export const BuildInfo: React.FC = () => {
  return (
    <View style={styles.container}>
      <Text style={styles.text}>{getBuildInfo()}</Text>
      <Text style={styles.subtext}>
        Branch: {BUILD_VERSION.branch}
      </Text>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    padding: 8,
    backgroundColor: '#f0f0f0',
    borderRadius: 4,
  },
  text: {
    fontSize: 10,
    color: '#666',
    fontFamily: 'Courier',
  },
  subtext: {
    fontSize: 9,
    color: '#999',
    fontFamily: 'Courier',
  },
});
```

**D. Add to Settings or Debug screen**:

```typescript
import { BuildInfo } from '../components/BuildInfo';

// In Settings screen or any screen:
<BuildInfo />
```

**Usage**:

```bash
# Before each build
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile
bash scripts/generate-build-version.sh
pnpm ios

# In running app, check Settings screen
# Should show: "Build 20251030-153045 (a3f2b1c)"
# Note the timestamp
# If timestamp is old (not recent), build cache issue!
```

**Success Criteria**:

- [ ] Version displayed in app matches current time (±5 minutes)
- [ ] Git commit hash matches current commit
- [ ] Version updates with each new build

---

### 1.2 Bundle Content Verification

**Purpose**: Verify JavaScript bundle contains your code changes

**A. Check bundle while Metro is running**:

```bash
# Start Metro
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile
pnpm start --reset-cache

# In another terminal, fetch bundle and search for your code
curl -s "http://localhost:8081/index.bundle?platform=ios&dev=true&minify=false" > /tmp/bundle.js

# Search for critical strings from your fixes
grep -c "Auth check timeout after 5s" /tmp/bundle.js
# Expected: 1 or more (found in bundle)

grep -c "setIsHydrated(true)" /tmp/bundle.js
# Expected: 1 or more (found in bundle)

grep -c "Promise.race.*timeoutPromise" /tmp/bundle.js
# Expected: 1 or more (found in bundle)

# Check build version is in bundle
grep -c "Build.*2025" /tmp/bundle.js
# Expected: 1 or more (build version embedded)
```

**Success Criteria**:

- [ ] All critical strings found in bundle
- [ ] Build timestamp in bundle matches current build
- [ ] No "Cannot find module" errors

**Red Flags**:

- String not found (count = 0) → Code not in bundle
- Old timestamp → Bundle is cached
- Metro serving from cache despite --reset-cache

**B. Force bundle regeneration**:

```bash
# Nuclear option - delete ALL caches
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile

# Stop Metro if running
pkill -f "react-native.*start" || true

# Clear Metro cache
rm -rf $TMPDIR/metro-*
rm -rf $TMPDIR/haste-map-*
rm -rf $TMPDIR/react-*

# Clear watchman
watchman watch-del-all

# Clear React Native cache
rm -rf ~/.rncache

# Restart Metro
pnpm start --reset-cache
```

---

### 1.3 Native Build Verification (iOS)

**Purpose**: Verify Xcode compiles latest code, not cached version

**A. Check Xcode build settings**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile/ios

# Verify build number was incremented
/usr/libexec/PlistBuddy -c "Print CFBundleVersion" mobile/Info.plist

# Expected: Higher than previous build
# Example: 5 (not 4)
```

**B. Verify CocoaPods are current**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile/ios

# Check Podfile.lock timestamp
ls -la Podfile.lock
# Expected: Recent timestamp (today)

# Check Pod versions match Podfile
pod outdated
# Expected: No critical pods outdated
```

**C. Force clean Xcode build**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile

# Clean Xcode project
xcodebuild clean -workspace ios/mobile.xcworkspace -scheme mobile

# Delete DerivedData
rm -rf ~/Library/Developer/Xcode/DerivedData/mobile-*

# Delete build folder
rm -rf ios/build

# Rebuild
pnpm ios
```

**Success Criteria**:

- [ ] Build number incremented
- [ ] Podfile.lock timestamp is recent
- [ ] DerivedData cleared before build
- [ ] Xcode compiles (not just linking cached build)

---

## Layer 2: Runtime Verification

### 2.1 Debug Log System

**Purpose**: Prove specific code paths execute at runtime

**A. Add verification logs to critical functions**:

**authStore.ts**:

```typescript
checkAuthStatus: async () => {
  // VERIFICATION LOG - proves this function runs
  console.log(`[VERIFY-${BUILD_VERSION.timestamp}] checkAuthStatus START`);

  set({ isLoading: true, error: null });

  try {
    const hasTokens = await tokenStorage.isAuthenticated();
    console.log(`[VERIFY-${BUILD_VERSION.timestamp}] hasTokens: ${hasTokens}`);

    if (!hasTokens) {
      console.log(`[VERIFY-${BUILD_VERSION.timestamp}] No tokens, returning false`);
      // ... rest of code
      return false;
    }

    // CRITICAL: This proves timeout code is deployed
    const timeoutPromise = new Promise<never>((_, reject) =>
      setTimeout(() => {
        console.log(`[VERIFY-${BUILD_VERSION.timestamp}] TIMEOUT TRIGGERED at 5s`);
        reject(new Error('Auth check timeout after 5s'));
      }, 5000)
    );

    console.log(`[VERIFY-${BUILD_VERSION.timestamp}] Starting Promise.race...`);
    const apiPromise = authApi.getCurrentUser();
    const response = await Promise.race([apiPromise, timeoutPromise]);

    console.log(`[VERIFY-${BUILD_VERSION.timestamp}] Auth check SUCCESS`);
    // ... rest of code
  } catch (error) {
    console.log(`[VERIFY-${BUILD_VERSION.timestamp}] Auth check ERROR:`, error.message);
    // ... error handling
  }
};
```

**RootNavigator.tsx**:

```typescript
useEffect(() => {
  const initialize = async () => {
    console.log(`[VERIFY-${BUILD_VERSION.timestamp}] RootNavigator initialize START`);
    try {
      await checkAuthStatus();
      console.log(`[VERIFY-${BUILD_VERSION.timestamp}] checkAuthStatus completed`);
    } catch (error) {
      console.error(`[VERIFY-${BUILD_VERSION.timestamp}] Error:`, error);
    } finally {
      console.log(`[VERIFY-${BUILD_VERSION.timestamp}] Setting isHydrated=true`);
      setIsHydrated(true);
    }
  };
  initialize();
}, [checkAuthStatus]);
```

**Key Points**:

- Include BUILD_VERSION.timestamp in every log
- This proves:
  1. New code is running (has latest timestamp)
  2. Specific code path executed
  3. Expected behavior occurred

**B. Monitor logs at startup**:

```bash
# iOS: Open React Native debugger or Metro terminal
# Android: adb logcat

# Look for logs with current build timestamp
# Example:
# [VERIFY-20251030-153045] RootNavigator initialize START
# [VERIFY-20251030-153045] checkAuthStatus START
# [VERIFY-20251030-153045] hasTokens: false
# [VERIFY-20251030-153045] No tokens, returning false
# [VERIFY-20251030-153045] Setting isHydrated=true
```

**Success Criteria**:

- [ ] Logs contain current build timestamp (not old timestamp)
- [ ] All expected log statements appear
- [ ] Log sequence matches expected code flow

**Red Flags**:

- No logs appear → Code not deployed or logs removed
- Old timestamp in logs → Running old build
- Log sequence wrong → Logic error or code not deployed

---

### 2.2 Runtime Checks

**Purpose**: Assert critical code is active at runtime

**A. Add runtime assertions**:

Create `src/utils/verifyDeployment.ts`:

```typescript
import { BUILD_VERSION } from '../version';

/**
 * Verify critical code is deployed
 * Call this at app startup in __DEV__ mode
 */
export const verifyDeployment = () => {
  if (!__DEV__) return; // Only in development builds

  console.log('=== DEPLOYMENT VERIFICATION START ===');

  // Check 1: Build version is recent
  const buildDate = BUILD_VERSION.timestamp.split('-')[0]; // YYYYMMDD
  const today = new Date().toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD

  if (buildDate !== today) {
    console.error(`❌ VERIFICATION FAILED: Build date (${buildDate}) is not today (${today})`);
    console.error('   → Possible build cache issue!');
  } else {
    console.log(`✅ Build date verified: ${buildDate}`);
  }

  // Check 2: Critical functions exist
  const criticalChecks = [
    { name: 'useAuthStore', check: () => typeof useAuthStore !== 'undefined' },
    {
      name: 'checkAuthStatus',
      check: () => typeof useAuthStore.getState().checkAuthStatus === 'function',
    },
    { name: 'tokenStorage', check: () => typeof tokenStorage !== 'undefined' },
  ];

  criticalChecks.forEach(({ name, check }) => {
    if (check()) {
      console.log(`✅ ${name} exists`);
    } else {
      console.error(`❌ ${name} MISSING - critical code not deployed!`);
    }
  });

  // Check 3: Environment variables loaded
  const envChecks = [{ name: 'API_URL', value: Config.REACT_APP_API_URL }];

  envChecks.forEach(({ name, value }) => {
    if (value) {
      console.log(`✅ ${name}: ${value}`);
    } else {
      console.error(`❌ ${name} NOT SET!`);
    }
  });

  console.log('=== DEPLOYMENT VERIFICATION END ===');
};
```

**B. Call in App.tsx**:

```typescript
import { verifyDeployment } from './utils/verifyDeployment';

function App() {
  useEffect(() => {
    verifyDeployment();
  }, []);

  // ... rest of app
}
```

**Expected Output**:

```
=== DEPLOYMENT VERIFICATION START ===
✅ Build date verified: 20251030
✅ useAuthStore exists
✅ checkAuthStatus exists
✅ tokenStorage exists
✅ API_URL: http://localhost:3000/api
=== DEPLOYMENT VERIFICATION END ===
```

**Failure Output**:

```
=== DEPLOYMENT VERIFICATION START ===
❌ VERIFICATION FAILED: Build date (20251029) is not today (20251030)
   → Possible build cache issue!
✅ useAuthStore exists
...
```

**Success Criteria**:

- [ ] All checks pass (✅)
- [ ] Build date is today
- [ ] No ❌ errors

---

### 2.3 Feature Flag System

**Purpose**: Enable/disable features at runtime to prove code is active

**A. Create feature flag file**:

`src/config/featureFlags.ts`:

```typescript
import { BUILD_VERSION } from '../version';

export const FEATURE_FLAGS = {
  // Enable 5-second timeout (should always be true in production)
  AUTH_TIMEOUT_ENABLED: true,

  // Enable non-blocking hydration (should always be true)
  NON_BLOCKING_HYDRATION: true,

  // Debug logging (enable for verification builds)
  DEBUG_LOGGING: __DEV__,

  // Build version for verification
  BUILD_VERSION: BUILD_VERSION.timestamp,
};

// Log feature flags at startup
export const logFeatureFlags = () => {
  if (!__DEV__) return;

  console.log('=== FEATURE FLAGS ===');
  Object.entries(FEATURE_FLAGS).forEach(([key, value]) => {
    console.log(`  ${key}: ${value}`);
  });
  console.log('====================');
};
```

**B. Use in critical code**:

```typescript
import { FEATURE_FLAGS } from '../config/featureFlags';

// In authStore.ts
checkAuthStatus: async () => {
  // Verify feature flag is active
  if (!FEATURE_FLAGS.AUTH_TIMEOUT_ENABLED) {
    console.error('❌ AUTH_TIMEOUT_ENABLED is FALSE - timeout disabled!');
  }

  // ... rest of code with timeout
};
```

**C. Display in app (debug screen)**:

```typescript
import { FEATURE_FLAGS } from '../config/featureFlags';

export const DebugScreen = () => {
  return (
    <View>
      <Text>Feature Flags:</Text>
      {Object.entries(FEATURE_FLAGS).map(([key, value]) => (
        <Text key={key}>{key}: {String(value)}</Text>
      ))}
    </View>
  );
};
```

**Success Criteria**:

- [ ] All expected feature flags set to true
- [ ] BUILD_VERSION matches current build
- [ ] Flags visible in debug screen

---

## Layer 3: Automated Verification

### 3.1 Pre-Build Verification Script

**Purpose**: Run checks before building to catch issues early

Create `scripts/pre-build-verify.sh`:

```bash
#!/bin/bash
set -e

echo "=== PRE-BUILD VERIFICATION ==="

# Check 1: Git has uncommitted changes
if [[ -n $(git status --porcelain) ]]; then
  echo "⚠️  WARNING: Uncommitted changes detected"
  git status --short
  read -p "Continue anyway? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check 2: Critical files exist
CRITICAL_FILES=(
  "src/stores/authStore.ts"
  "src/navigation/RootNavigator.tsx"
  "src/utils/secureStorage.ts"
)

for file in "${CRITICAL_FILES[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "❌ CRITICAL FILE MISSING: $file"
    exit 1
  else
    echo "✅ $file exists"
  fi
done

# Check 3: Critical code patterns exist
echo "Checking critical code patterns..."

grep -q "Promise.race.*timeoutPromise" src/stores/authStore.ts || {
  echo "❌ Timeout code not found in authStore.ts"
  exit 1
}
echo "✅ Timeout code found"

grep -q "setIsHydrated(true)" src/navigation/RootNavigator.tsx || {
  echo "❌ Hydration code not found in RootNavigator.tsx"
  exit 1
}
echo "✅ Hydration code found"

# Check 4: Dependencies installed
if [[ ! -d "node_modules" ]]; then
  echo "❌ node_modules missing - run pnpm install"
  exit 1
fi
echo "✅ node_modules exists"

# Check 5: iOS pods installed (if iOS build)
if [[ -d "ios" ]] && [[ ! -d "ios/Pods" ]]; then
  echo "❌ CocoaPods not installed - run: cd ios && pod install"
  exit 1
fi
echo "✅ CocoaPods installed"

echo "=== PRE-BUILD VERIFICATION PASSED ==="
```

**Usage**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile
bash scripts/pre-build-verify.sh
# Only build if all checks pass
```

---

### 3.2 Post-Build Verification Script

**Purpose**: Verify build artifacts after compilation

Create `scripts/post-build-verify.sh`:

```bash
#!/bin/bash
set -e

echo "=== POST-BUILD VERIFICATION ==="

# Check 1: Build completed
if [[ ! -d "ios/build" ]]; then
  echo "❌ iOS build folder not found"
  exit 1
fi
echo "✅ iOS build exists"

# Check 2: App binary exists
APP_PATH="ios/build/Build/Products/Debug-iphonesimulator/mobile.app"
if [[ ! -d "$APP_PATH" ]]; then
  echo "❌ App binary not found at $APP_PATH"
  exit 1
fi
echo "✅ App binary exists"

# Check 3: Bundle exists in app
if [[ ! -f "$APP_PATH/main.jsbundle" ]]; then
  echo "⚠️  WARNING: No bundled JavaScript (using Metro in dev mode)"
else
  echo "✅ JavaScript bundle found"

  # Verify bundle contains critical code
  if grep -q "Auth check timeout after 5s" "$APP_PATH/main.jsbundle"; then
    echo "✅ Timeout code found in bundle"
  else
    echo "❌ Timeout code NOT in bundle!"
    exit 1
  fi
fi

# Check 4: Build version incremented
BUILD_NUMBER=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" ios/mobile/Info.plist)
echo "Build number: $BUILD_NUMBER"

# Check 5: Version file generated
if [[ -f "src/version.ts" ]]; then
  echo "✅ Version file exists"
  cat src/version.ts | head -10
else
  echo "❌ Version file not generated"
  exit 1
fi

echo "=== POST-BUILD VERIFICATION PASSED ==="
```

---

## Verification Checklist

### Before Building

- [ ] Run `bash scripts/pre-build-verify.sh`
- [ ] All critical files exist
- [ ] Critical code patterns found in source
- [ ] Dependencies installed
- [ ] Git status clean (or changes documented)

### During Building

- [ ] Clean all caches (Metro, Xcode, CocoaPods)
- [ ] Generate build version: `bash scripts/generate-build-version.sh`
- [ ] Metro starts with `--reset-cache`
- [ ] Xcode builds (not just links)

### After Building

- [ ] Run `bash scripts/post-build-verify.sh`
- [ ] App binary exists
- [ ] Bundle contains critical code (if bundled)
- [ ] Build number incremented
- [ ] Version file generated

### At Runtime

- [ ] Check build version in app matches current build
- [ ] Verification logs appear with current timestamp
- [ ] All runtime checks pass (verifyDeployment)
- [ ] Feature flags correct
- [ ] Expected behavior observed

---

## Common Build Cache Issues

### Issue: Metro serves old bundle

**Symptoms**:

- Code changes not reflected
- Old logs still appear
- Old timestamp in BUILD_VERSION

**Solution**:

```bash
# Kill Metro
pkill -f "react-native.*start"

# Clear Metro cache
rm -rf $TMPDIR/metro-*
rm -rf $TMPDIR/haste-map-*
watchman watch-del-all

# Restart Metro
pnpm start --reset-cache
```

### Issue: Xcode uses cached build

**Symptoms**:

- Build completes instantly (< 10 seconds)
- New code not in app
- Build number didn't increment

**Solution**:

```bash
# Clean Xcode
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile
xcodebuild clean -workspace ios/mobile.xcworkspace -scheme mobile
rm -rf ~/Library/Developer/Xcode/DerivedData/mobile-*
rm -rf ios/build

# Rebuild
pnpm ios
```

### Issue: CocoaPods cached

**Symptoms**:

- Native module changes not applied
- Pod versions wrong
- Linker errors

**Solution**:

```bash
cd /Users/devarisbrown/Code/projects/gtsd/apps/mobile/ios
rm -rf Pods Podfile.lock
pod install
cd ..
pnpm ios
```

---

## Quick Verification Commands

**One-liner to verify build is current**:

```bash
# Check if build version in app matches current time
# Run in app console or Metro logs
console.log(`Build: ${BUILD_VERSION.timestamp}, Now: ${new Date().toISOString()}`);
# If timestamps differ by > 1 hour, build is cached
```

**Verify critical code in bundle**:

```bash
curl -s "http://localhost:8081/index.bundle?platform=ios&dev=true" | \
  grep -E "(Auth check timeout|setIsHydrated|Promise.race)" | wc -l
# Expected: 3 or more (all strings found)
```

**Check all verification logs**:

```bash
# In Metro terminal, filter for verification logs
# Look for logs with [VERIFY-{timestamp}]
# Timestamp should match current build
```

---

## Success Criteria

Build is verified when:

- [ ] Build version timestamp is within last 10 minutes
- [ ] All verification logs have current timestamp
- [ ] Bundle contains critical code strings
- [ ] Build number incremented
- [ ] Runtime checks all pass (no ❌)
- [ ] Expected behavior observed (e.g., 5-second timeout)
- [ ] No build cache warnings

If ANY criterion fails: **Build is NOT verified. Do not proceed with testing.**

---

## Time to Verify

| Step                 | Time              |
| -------------------- | ----------------- |
| Pre-build checks     | 2 min             |
| Clean caches         | 3 min             |
| Build                | 5-10 min          |
| Post-build checks    | 2 min             |
| Runtime verification | 5 min             |
| **Total**            | **17-22 minutes** |

**This time is mandatory for each build to ensure verification.**
